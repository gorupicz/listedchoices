datasource db {
  provider = "mysql"
  url      = env("MYSQL_URL")
}

model User {
  id             Int            @id @default(autoincrement())
  email          String         @unique
  password       String
  username       String         @unique
  first_name     String
  last_name      String
  biography      String
  facebook       String
  linkedin       String
  instagram      String
  photograph     String
  phone_number   String?
  role           UserRole
  oauth_provider String?
  oauth_id       String?
  oauth_token    String?
  created_at     DateTime       @default(now())
  updated_at     DateTime       @updatedAt
  properties     Property[]     @relation("PropertyManager")
  reviews        Review[]
  bought_shares  Transactions[] @relation("Buyer")
  sold_shares    Transactions[] @relation("Seller")
}

model Property {
  id                  Int                 @id @default(autoincrement())
  slug                String              @unique
  legal_name          String
  address             String
  city                String
  state               String
  postal_code         String
  country             String
  google_maps         String              @db.VarChar(2048)
  manager_id          Int
  price               Decimal             @db.Decimal(10, 4)
  created_at          DateTime            @default(now())
  updated_at          DateTime            @updatedAt
  listings            Listing[]
  manager             User                @relation("PropertyManager", fields: [manager_id], references: [id])
  transactions        Transactions[]
  share_price_history SharePriceHistory[]
}

model PlatformAccount {
  id          Int       @id @default(autoincrement())
  platform    Platform
  account_id  String
  status      String
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  listings    Listing[] // Back-relation to Listing
}

model Listing {
  id                  Int             @id @default(autoincrement())
  property_id         Int
  platform_account_id Int
  listing_id          String
  url                 String?
  status              ListingStatus
  created_at          DateTime        @default(now())
  updated_at          DateTime        @updatedAt
  property            Property        @relation(fields: [property_id], references: [id])
  platform_account    PlatformAccount @relation(fields: [platform_account_id], references: [id])
  reservations        Reservation[] // Relation to reservations
}

model Reservation {
  id                  Int      @id @default(autoincrement())
  guest_name          String
  start_date          DateTime
  end_date            DateTime
  reservation_id      String
  base_price          Decimal  @db.Decimal(10, 2)
  platform_commission Decimal  @db.Decimal(10, 2)
  currency            Currency
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt
  reviews             Review[]
  listing_id          Int // Foreign key field
  listing             Listing  @relation(fields: [listing_id], references: [id])
}

model Review {
  id             Int         @id @default(autoincrement())
  reservation_id Int
  rating         Int
  comment        String
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt
  reservation    Reservation @relation(fields: [reservation_id], references: [id])
  user_id        Int?
  user           User?       @relation(fields: [user_id], references: [id])
}

model ExchangeRate {
  id    Int     @id @default(autoincrement())
  date  DateTime
  value Decimal @db.Decimal(10, 4)

  @@unique([date])
}

model Transactions {
  id               Int      @id @default(autoincrement())
  property_id      Int
  property         Property @relation(fields: [property_id], references: [id])
  buyer_id         Int
  buyer            User     @relation("Buyer", fields: [buyer_id], references: [id])
  seller_id        Int
  seller           User     @relation("Seller", fields: [seller_id], references: [id])
  shares_traded    Int
  price_per_share  Decimal  @db.Decimal(10, 4)
  currency         Currency
  transaction_date DateTime @default(now())
}

model SharePriceHistory {
  id          Int               @id @default(autoincrement())
  property_id Int
  property    Property          @relation(fields: [property_id], references: [id])
  date        DateTime          @default(now())
  price       Decimal           @db.Decimal(10, 2)
  reason      PriceChangeReason
}

enum PriceChangeReason {
  PROPERTY_VALUE_UPDATE
  MARKET_DEMAND
  DIVIDEND_PAYMENT
}

enum UserRole {
  investor
  property_manager
  super_admin
}

enum Platform {
  Airbnb
  Booking
  Vrbo
  Direct
}

enum ListingStatus {
  active
  inactive
  closed
  cancelled
}

enum Currency {
  USD
  MXN
}
